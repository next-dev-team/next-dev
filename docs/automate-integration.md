# API Integration Guide

This guide shows how to fully automate UI + API integration using our MCP tool and Kubb-generated client/hooks. You can provide only a route and the desired endpoints, and the system will update the OpenAPI spec, generate code into `gen/**`, and scaffold a production-ready page.

## Prerequisites

- Node `>= 20.11.0`
- `pnpm` installed (`pnpm@10.22.0`)
- Repo bootstrapped and dependencies installed
- OpenAPI spec under `packages/api-spec/openapi.yaml`
- Kubb configured in `packages/api-spec/kubb.config.ts`
- UI library available `@rnr/rnr-ui` and any other base on user tell more information
- A React Query provider is required for components using generated hooks

## Quickstart (MCP – Recommended)

Use the `integration_new_ui` tool to fully automate the integration. It:

- Updates `packages/api-spec/openapi.yaml` with the requested endpoints
- Runs Kubb generation to produce `src/gen/types`, `src/gen/client`, and `src/gen/hooks`
- Creates a Next.js page integrated with generated hooks and cache-invalidation

Example tool call input:

```json
{
  "routePath": "/todo",
  "entity": "Todo",
  "uiPattern": "list",
  "operations": ["read", "create", "update", "delete"]
}
```

Expected results:

- OpenAPI updated with:
  - `GET/POST /api/todos`
  - `GET/PUT/DELETE /api/todos/{id}` (based on `operations`)
- Kubb generation executed:
  - Hooks available at `packages/api-spec/src/gen/hooks`
- New page created:
  - `apps/docs/app/todo/page.tsx` (client component)
  - Provides `QueryClientProvider`
  - Imports hooks from `@rnr/api-spec/src/gen/hooks`
  - Implements loading, error, and mutation cache invalidation via `getApiTodosQueryKey`

## Generated Hooks Overview

Generated by Kubb from OpenAPI:

- Types under `packages/api-spec/src/gen/types`
- Axios client under `packages/api-spec/src/gen/client`
- React Query hooks under `packages/api-spec/src/gen/hooks`

Common imports:

```ts
import {
  useGetApiTodos,
  usePostApiTodos,
  usePutApiTodosId,
  useDeleteApiTodosId,
  getApiTodosQueryKey,
} from '@rnr/api-spec/src/gen/hooks';
```

## Page Integration Pattern

Each generated page:

- Uses `'use client'` and wraps content in `QueryClientProvider`
- Imports hooks from `@rnr/api-spec/src/gen/hooks`
- Implements basic list rendering and mutation `onSuccess` invalidations
- Uses `PageContainer` from `@rnr/rnr-ui`

Cache invalidation pattern:

```ts
qc.invalidateQueries({ queryKey: getApiTodosQueryKey() });
```

## Manual Workflow (Alternative)

If you prefer manual steps:

- Update OpenAPI at `packages/api-spec/openapi.yaml`
- Run Kubb generation:
  - `pnpm --filter @rnr/api-spec gen:api`
- Create a page under `apps/docs/app/<route>/page.tsx` and import hooks:
  - `@rnr/api-spec/src/gen/hooks`
- Provide a `QueryClientProvider` at page or app layout level

## Verification

- Generated files present in `packages/api-spec/src/gen/**`
- Hooks compile and run without type errors
- OpenAPI endpoints correspond to your backend
- UI renders and updates cache properly on mutations

## Troubleshooting

- Kubb generation fails:
  - Check logs captured during tool execution
  - Validate `openapi.yaml` syntax (YAML structure and schemas)
- Missing React Query provider:
  - Ensure `QueryClientProvider` wraps hook usage
- Hook names mismatch:
  - Confirm hook names match OpenAPI paths (e.g., `/api/todos` → `useGetApiTodos`)
- Base URL:
  - Default axios client points to server in `openapi.yaml` `servers`; update if needed

## Production Considerations

- Error handling:
  - Surface `error` from queries/mutations and handle gracefully
- Loading states:
  - Use `isLoading`/`isPending` patterns with minimal UI flicker
- Cache strategy:
  - Invalidate or update cache keys on mutations using exported `queryKey` helpers
- Types:
  - Keep OpenAPI schemas aligned with backend responses for strict type safety

## Related

- Kubb config: `packages/api-spec/kubb.config.ts`
- OpenAPI spec: `packages/api-spec/openapi.yaml`
- Generated hooks index: `packages/api-spec/src/gen/hooks/index.ts`
- UI components: `@rnr/rnr-ui`
